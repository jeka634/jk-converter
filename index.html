
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>JK Converter with TON Wallet</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script async src="https://telegram.org/js/telegram-web-app.js"></script>
  <script defer src="style.js"></script>
</head>
<body class="bg-gray-50 dark:bg-gray-900 min-h-screen flex items-center justify-center p-4 text-gray-800 dark:text-gray-100 transition-colors">
  <div id="app" class="bg-white dark:bg-gray-800 shadow-lg rounded-xl p-6 w-full max-w-md relative space-y-4">
    <button id="themeToggle" class="absolute top-2 left-2 text-sm px-2 py-1 bg-gray-200 dark:bg-gray-700 rounded">üåô</button>

    <img src="jk-icon.png" alt="JK Logo" class="absolute top-4 right-4 w-8 h-8 rounded-full" />
    <button id="connectBtn" class="w-full bg-[#0088cc] hover:bg-[#007ab8] text-white font-semibold py-2 rounded-xl">
      –ü–æ–¥–∫–ª—é—á–∏—Ç—å TON –∫–æ—à–µ–ª—ë–∫
    </button>
    <div id="walletInfo" class="text-sm text-gray-700 dark:text-gray-300"></div>
    <div id="balanceInfo" class="text-lg font-medium">–í–∞—à –±–∞–ª–∞–Ω—Å $JK: ‚Äî</div>
    <div class="text-sm">
      <strong>–ö—É—Ä—Å:</strong><br/>
      1 $JK = <span id="jk-usdt-display">0.000002233</span> USDT<br/>
      1 USDT = <span id="usdt-rub-display">90.00</span> RUB
    </div>
    <div class="grid grid-cols-2 gap-4">
      <div>
        <label class="text-xs">1 JK –≤ USDT</label>
        <input type="number" id="jk-usdt" value="0.000002233" step="any" class="w-full border rounded px-2 py-1 dark:bg-gray-700 dark:text-white" onchange="updateRates()"/>
      </div>
      <div>
        <label class="text-xs">1 USDT –≤ RUB</label>
        <input type="number" id="usdt-rub" value="90.00" step="any" class="w-full border rounded px-2 py-1 dark:bg-gray-700 dark:text-white" onchange="updateRates()"/>
      </div>
    </div>
    <div>
      <label class="block text-sm font-medium">–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏</label>
      <select id="direction" class="w-full border rounded px-3 py-2 dark:bg-gray-700 dark:text-white">
        <option value="rub-to-jk">–†—É–±–ª–∏ ‚Üí $JK</option>
        <option value="jk-to-rub">$JK ‚Üí –†—É–±–ª–∏</option>
      </select>
    </div>
    <div>
      <label for="amount" class="block text-sm font-medium">–°—É–º–º–∞</label>
      <input type="number" id="amount" placeholder="500" step="any" class="w-full border rounded px-3 py-2 dark:bg-gray-700 dark:text-white"/>
    </div>
    <button onclick="convert()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 rounded-xl">
      –†–∞—Å—Å—á–∏—Ç–∞—Ç—å
    </button>
    <div id="result" class="mt-4 text-lg"></div>
  </div>
  <script type="module">
    import { TonClient } from 'https://cdn.skypack.dev/@tonclient/core';
    import { GaspumpJetton, JettonWallet } from 'https://cdn.skypack.dev/@gaspump/sdk';

    const JK_CONTRACT = 'EQCktaxD_raMP6IARzMUL2XY-2hoe9N59xl11L6D8UOkqBI7';
    let userAddress = null;
    let walletAddress = null;
    let client;
    let jkJetton;

    function initSdk() {
      client = new TonClient({ network: { server_address: 'main.ton.dev' } });
      jkJetton = new GaspumpJetton({ client, address: JK_CONTRACT });
    }

    async function connectWallet() {
      if (!window.ton) {
        alert('–û—Ç–∫—Ä–æ–π—Ç–µ –≤ Tonkeeper –∏–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ');
        return;
      }
      try {
        const permissions = await window.ton.requestPermissions({ permissions: ['tonClient'] });
        userAddress = permissions.account;
        document.getElementById('walletInfo').textContent = `–ê–¥—Ä–µ—Å: ${userAddress}`;
        await loadBalance();
      } catch (e) {
        console.error(e);
        alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å –∫–æ—à–µ–ª—ë–∫');
      }
    }

    async function getJettonWallet() {
      walletAddress = await jkJetton.getWalletAddress(userAddress);
      return walletAddress;
    }

    async function loadBalance() {
      if (!userAddress) return;
      initSdk();
      await getJettonWallet();
      const jw = new JettonWallet({ client, address: walletAddress });
      const balBn = await jw.getBalance();
      const balance = Number(balBn) / 1e9;
      document.getElementById('balanceInfo').textContent = `–í–∞—à –±–∞–ª–∞–Ω—Å $JK: ${balance.toFixed(2)}`;
    }

    function updateRates() {
      const jkToUsdt = parseFloat(document.getElementById('jk-usdt').value);
      const usdtToRub = parseFloat(document.getElementById('usdt-rub').value);
      document.getElementById('jk-usdt-display').textContent = jkToUsdt.toFixed(9);
      document.getElementById('usdt-rub-display').textContent = usdtToRub.toFixed(2);
    }

    function convert() {
      const amount = parseFloat(document.getElementById('amount').value);
      const jkToUsdt = parseFloat(document.getElementById('jk-usdt').value);
      const usdtToRub = parseFloat(document.getElementById('usdt-rub').value);
      const direction = document.getElementById('direction').value;
      if (isNaN(amount) || amount <= 0) {
        document.getElementById('result').innerHTML = '<span class="text-red-500">–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —á–∏—Å–ª–æ</span>'; return;
      }
      const jkToRub = jkToUsdt * usdtToRub;
      let text;
      if (direction === 'rub-to-jk') {
        const jkAmt = amount / jkToRub;
        text = `<strong>${amount.toFixed(2)} ‚ÇΩ</strong> = <strong>${jkAmt.toFixed(2)} $JK</strong>`;
      } else {
        const rubAmt = amount * jkToRub;
        text = `<strong>${amount.toFixed(2)} $JK</strong> = <strong>${rubAmt.toFixed(2)} ‚ÇΩ</strong>`;
      }
      document.getElementById('result').innerHTML = text;
    }

    document.getElementById('connectBtn').addEventListener('click', connectWallet);
  </script>
</body>
</html>
